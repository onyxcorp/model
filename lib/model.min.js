var lodash={arrays:{remove:require("lodash-node/modern/arrays/remove"),difference:require("lodash-node/modern/arrays/difference")},collections:{forEach:require("lodash-node/modern/collections/forEach"),find:require("lodash-node/modern/collections/find"),filter:require("lodash-node/modern/collections/filter")},objects:require("lodash-node/modern/objects"),utils:require("lodash-node/modern/utilities")},SchemaValidator=require("jsonschema").Validator,Formatter=require("formatter"),Transmuter=require("transmuter"),extend=require("backbone-extend-standalone"),ModelValidator;ModelValidator=new SchemaValidator;var Model=function(t,e){var i=t||{};e=e||{},this.cid=lodash.utils.uniqueId("c"),this.revision=1,this.attributes={},e.collection&&(this.collection=e.collection),i=lodash.objects.defaults({},i,lodash.utils.result(this,"defaults")),this.set(i,e),this.changed={},this.initialize.apply(this,arguments)};lodash.objects.assign(Model.prototype,{_validTypes:{},_schema:null,_dynamicAttributes:{},changed:null,validationError:"",idAttribute:"id",className:"Model",initialize:function(){if(!this._schema)throw new Error("You forgot to set a _schema for the model, it is a required item")},toJSON:function(){return lodash.objects.cloneDeep(this.attributes)},has:function(t){return null!=this.get(t)},find:function(t,e,i){var s;if(i=i||!0,s=this.attributes[t],lodash.objects.isNumber(s))throw new Error("Find can only be performed on String, Array or Object type attribute");return lodash.collections[i?"find":"filter"](this.attributes[t],e)},to:function(t,e){t=Formatter.camelize(t);var i=[].slice.call(arguments);if(lodash.arrays.remove(i,function(i){return i===t||i===e}),i.unshift(this.attributes[e]),this[t])return this[t].apply(this,i);if(Formatter[t])return Formatter[t].apply(null,i);throw new Error("Formatting function not found: "+t+".","index.js",135)},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return!this.has(this.idAttribute)},getRevision:function(){return this.revision},get:function(t){if(this._schema.properties[t])return this.attributes[t];throw new Error("Trying to get the attribute: "+t+", but it was not found at the current model _schema","index.js",160)},set:function(t,e,i){var s,r,o,a,n,h,l;if(null==t)return this;if("object"==typeof t?(r=t,i=e):(r={})[t]=e,l={unset:!1},i=lodash.objects.defaults({},i,l),!this.checkSchema(r))return!1;o=i.unset,a=[],this._previousAttributes=lodash.objects.clone(this.attributes),this.changed={},h=this._previousAttributes,this.idAttribute in r&&(this.id=r[this.idAttribute]);for(s in r)n=r[s],lodash.objects.isEqual(this.attributes[s],n)||a.push(s),lodash.objects.isEqual(h[s],n)?delete this.changed[s]:this.changed[s]=e,o?delete this.attributes[s]:this.attributes[s]=n;return this.hasChanged()&&(this.revision+=1,lodash.objects.isEmpty(this._dynamicAttributes)||lodash.collections.forEach(this._dynamicAttributes,function(t,e){if("function"!=typeof t)throw new TypeError("DynamicAttributes must have a function as a value");this.attributes[e]=t.apply(this)}.bind(this))),this.collection&&this.collection.modelUpdate(this),this},unset:function(t,e){return this.set(t,void 0,lodash.objects.assign({},e,{unset:!0}))},clear:function(t){var e,i;e={};for(i in this.attributes)e[i]=void 0;return this.set(e,lodash.objects.assign({},t,{unset:!0}))},hasChanged:function(t){return null==t?!lodash.objects.isEmpty(this.changed):lodash.objects.has(this.changed,t)},previous:function(t){return null!=t&&this._previousAttributes?this._previousAttributes[t]:null},previousAttributes:function(){return lodash.objects.clone(this._previousAttributes)},isValid:function(){return!Transmuter.toBoolean(this.validationError)},checkSchema:function(t){var e,i,s;if(this._validTypes&&lodash.objects.assign(ModelValidator.attributes,this._validTypes),t=lodash.objects.assign({},this.attributes,t),!this._schema)throw new Error("You must set a _schema for this model, otherwise validate will always return false");if(i=lodash.objects.keys(this._schema.properties).concat(lodash.objects.keys(this._dynamicAttributes)),s=lodash.arrays.difference(lodash.objects.keys(t),i),!lodash.objects.isEmpty(s))throw new Error("You are trying to set attributes that are not described on the model _schema:"+s.toString());return e=ModelValidator.validate(t,this._schema),e.valid||(this.validationError=e.toString()),this.isValid()},_previousAttributes:{}}),lodash.collections.forEach(["transform","values","pairs","invert","pick","omit"],function(t){lodash.objects[t]&&(Model.prototype[t]=function(){var e=[].slice.call(arguments);return e.unshift(this.attributes),lodash.objects[t].apply(lodash.objects,e)})}),Model.extend=extend,module.exports=Model;
